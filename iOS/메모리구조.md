# 메모리 구조

## 1. 메모리의 구조 
프로그램이 실행되면 OS는 RAM에 이 프로그램을 위한 공간을 할당해준다.     
그 공간은 총 4개```(Code, Data, Heap, Stack)```으로 나뉜다.     

### 1-1. Code 영역
우리가 작성한 소스코드가 기계어 형태로 변환되어 저장된다.      
컴파일 타임에 결정, 코드가 변경되지않도록 ```ReadOnly``` 형태로 저장된다.      

### 1-2. Data 영역
```전역변수, static변수```가 저장된다.      
프로그램 시작과 동시에 할당 후 프로그램 종료 시 메모리에서 해제       
실행 도중 값이 변경될 수 있으니 Read-Write로 지정       
```swift 
struce Korean {
    static let country = "Korea"
}

var name: String?
var age: Int?

func hello() {

}
```
country는 static 상수로,      
name,age는 전역변수로 데이터 영역에 할당된다.        

### 1-3. Heap 영역 
프로그래머가 직접 할당/해제하는 영역       
프로그래머는 malloc, calloc으로 힙에 메모리를 할당할 수 있으며,    
이를 ```'동적할당'```이라고 한다.        
사용하고 난 후에 반드시 메모리 해제를 해줘야한다.       
그렇지 않으면 ```memory leak```이 발생한다.         
Core, Data, Stack 중에 유일하게 ```런타임 시```에 결정되기 때문에      
데이터의 크기가 확실하지 않을때 사용한다.     

사실 스위프트에서는 malloc, calloc을 이용해 메모리를 할당할 일이 없다.      
왜냐하면``` 클래스 인스턴스, 클로저``` 같은 참조타입의 값이 힙에 자동 할당되기 때문이다.      
메모리 해제 또한 ```ARC```를 통해 힙에 할당된 메모리가             
더 이상 쓸모 없어지면(참조되지 않으면)``` 자동으로``` 해제해주기 때문이다.      
```
힙의 장점 
1. 메모리 크기에 제한이 없다. 
2. 본질적인 범위가 전역이기 때문에, 프로그램의 모든 함수에서 엑세스할 수 있다.     

힙의 단점 
1. 속도 저하.
2. 메모리를 직접 관리해줘야 함 
```
### 1-4. Stack 영역 
함수 호출 시 함수의 ```지역변수, 매개변수, 리턴 값 ```등등이 저장된다.       
함수가 종료되면 저장된 메모리도 해제된다.      
컴파일 타임이 결정되기 때문에 ```무한히 할당할 수 없다```.      

```swift
func name(_first:String, _all:String) -> String{           
    let fullName = frist + all
    return fullName
}
```
이렇게 우리가 함수를 호출하면 name안에 선언된 ```파라미터, 지역변수``` 등을 스택에 할당한다.       
그리고 위 name함수가 종료되면 스택에 저장된 메모리는 모두 알아서 반환된다.      
```
스택의 장점 
1. CPU가 스택메모리를 효율적으로 구성하기 때문에 속도가 매우 빠르다.
2. 메모리를 직접 해제해주지 않아도 된다.

스택의 단점
1. 메모리 크기에 제한이 있다.
2. 지역 변수만 액세스 가능하다. 
```

## 2. 힙 vs 스택

### 2-1. 힙은 언제쓰고 스택은 언제 써?

```데이터의 크기를 모르거나, 스택이 저장하기에는 큰 데이터```는 힙에 할당한다.      
그 외에는 스택에 할당한다. (인스턴스, 클로저 등 자동으로 힙에 할당되는 것은 제외!)       
만약 스택에 너무 많은 메모리를 할당하면 ```스택 오버 플로우```가 발생!        
스택 오버 플로우가 발생하면 iOS앱이 죽어버리기 때문에 조심!      

### 2-2. 힙과 스택의 메모리 관계
사실 힙과 스택은 같은 메모리 영역을 공유한다.      
![](https://blog.kakaocdn.net/dn/cZLkE0/btqHR7wpUtQ/B94lHrkyUvqj1GwUHxojUK/img.png)
같은 메모리 공간이지만      
<b>힙</b>은 ```낮은 메모리 주소로부터 할당```을 받는 것이고,        
<b>스택</b>은 ```높은 메모리 주소로부터 할당```을 받는다.   
따라서 힙도 자신의 영역 외로 확장하려다 보면,       
```힙 오버 플로우```가 발생한다.      

출처: https://babbab2.tistory.com/25
